<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Super Helpers: The Bee Savers | Interactive Storybook</title>
  <meta name="description"
    content="Interactive game experience based on the 'Super Helpers: The Bee Savers' picture book. Help the little bees protect the environment!" />
  <meta name="keywords"
    content="super helpers, bee savers, bees, rescue, environment, three.js, webgl, game, 3d, animation" />
  <link rel="shortcut icon" href="favicon.ico">
  <link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,700italic' rel='stylesheet'
    type='text/css'>
  <!-- Import Howler.js audio library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <!-- CSS will be imported via main.js -->
  <style>
    .start-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0);
      /* Remove original background color */
      z-index: 10;
      overflow: hidden;
      /* Prevent background overflow */
    }

    .start-screen::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('./img/cover.png');
      /* Use relative path */
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.9;
      /* Increase transparency slightly to make the image clearer */
      filter: blur(2px) brightness(1.1);
      /* Fine-tune blur effect and increase brightness */
      z-index: -1;
      animation: fadeIn 2s ease-in-out, slowZoom 30s infinite alternate;
      /* Add slow zoom effect */
      transform-origin: center;
    }

    .start-content {
      background-color: rgba(0, 0, 0, 0.6);
      /* Semi-transparent background for content area */
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      /* Enhance glass effect */
      -webkit-backdrop-filter: blur(8px);
      /* Safari support */
      border: 1px solid rgba(255, 255, 255, 0.1);
      /* Add subtle border */
      animation: slideUp 1.2s ease-out;
      /* Content area slide-in effect */
      max-width: 80%;
      text-align: center;
      transition: all 0.5s ease;
    }

    .start-content:hover {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
      transform: translateY(-5px);
    }

    .start-button {
      background-color: #f25346;
      color: white;
      font-size: 24px;
      padding: 16px 42px;
      border: none;
      border-radius: 50px;
      /* More rounded button */
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      font-family: 'Playfair Display', serif;
      margin-top: 30px;
      position: relative;
      overflow: hidden;
      animation: pulse 2s infinite;
      /* Button pulse effect */
      box-shadow: 0 6px 20px rgba(242, 83, 70, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: 1px;
    }

    .start-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent);
      transition: all 0.6s;
    }

    .start-button:hover {
      background-color: #e6352a;
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 10px 30px rgba(242, 83, 70, 0.6);
      letter-spacing: 3px;
    }

    .start-button:hover::before {
      left: 100%;
    }

    .start-title {
      color: white;
      font-size: 60px;
      margin-bottom: 20px;
      font-family: 'Playfair Display', serif;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }

    .start-subtitle {
      color: #d8d0d1;
      font-size: 24px;
      margin-bottom: 20px;
      font-family: 'Playfair Display', serif;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
    }

    .book-cover {
      width: 220px;
      height: 220px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
      margin-bottom: 20px;
      transition: transform 0.3s ease;
      animation: float 3s ease-in-out infinite;
      /* Floating effect */
    }

    .book-cover:hover {
      transform: scale(1.05);
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        filter: blur(10px) brightness(0.8);
      }

      100% {
        opacity: 0.9;
        filter: blur(2px) brightness(1.1);
      }
    }

    @keyframes slideUp {
      0% {
        transform: translateY(70px) scale(0.95);
        opacity: 0;
        filter: blur(5px);
      }

      70% {
        filter: blur(1px);
      }

      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
        filter: blur(0px);
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes slowZoom {
      0% {
        transform: scale(1);
      }

      100% {
        transform: scale(1.1);
      }
    }

    body {
      margin: 0;
      overflow: hidden;
    }

    #videoPreload,
    #videoPreload2 {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 10px;
      height: 10px;
    }

    /* Skip button style */
    #skipButton {
      position: absolute;
      bottom: 30px;
      right: 30px;
      padding: 12px 25px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 25px;
      font-family: "Microsoft YaHei", "SimHei", Arial, sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    #skipButton:hover {
      background-color: rgba(255, 255, 255, 0.9);
      color: #333;
      transform: scale(1.05);
    }
  </style>
  <!--[if IE]>
		  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
</head>

<body>
  <div class="game-holder" id="gameHolder">
    <div class="header">
      <h1><span>super</span>Helpers</h1>
      <h2>Bee Rescue Mission</h2>
      <div class="score" id="score">
        <div class="score__content" id="level">
          <div class="score__label">level</div>
          <div class="score__value score__value--level" id="levelValue">1</div>
          <svg class="level-circle" id="levelCircle" viewbox="0 0 200 200">
            <circle id="levelCircleBgr" r="80" cx="100" cy="100" fill="none" stroke="#d1b790" stroke-width="24px" />
            <circle id="levelCircleStroke" r="80" cx="100" cy="100" fill="none" #f25346 stroke="#68c3c0"
              stroke-width="14px" stroke-dasharray="502" />
          </svg>
        </div>
        <div class="score__content" id="dist">
          <div class="score__label">distance</div>
          <div class="score__value score__value--dist" id="distValue">000</div>
        </div>
        <div class="score__content" id="energy">
          <div class="score__label">energy</div>
          <div class="score__value score__value--energy" id="energyValue">
            <div class="energy-bar" id="energyBar"></div>
          </div>
        </div>
      </div>
      <div class="audio-controls">
        <button class="audio-btn" id="toggleAudio">
          <span class="audio-icon">🔊</span>
        </button>
      </div>
    </div>
    <div class="world" id="world"></div>
    <div class="message message--replay" id="replayMessage">Click to restart</div>
    <div class="message message--instructions" id="instructions">Collect blue flowers<span>Avoid dangerous
        items</span>
    </div>
    <div class="message message--pointer-lock" id="pointerLockHint">Press ESC to unlock mouse</div>

    <!-- Start Game Screen -->
    <div class="start-screen" id="startScreen">
      <div class="start-content">
        <h1 class="start-title">Super Helpers</h1>
        <h2 class="start-subtitle">🌸 Help bees collect flowers and save the environment together! 🌸</h2>
        <button class="start-button" id="startButton">Start Mission</button>
        <p class="start-tip">Click on the game to lock your pointer for better control</p>
      </div>
    </div>
  </div>
  <!-- Import via Vite -->
  <script type="module" src="/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const startScreen = document.getElementById('startScreen');
      const startButton = document.getElementById('startButton');

      // Hide game elements until start button is clicked
      document.querySelector('.header').style.display = 'none';
      document.getElementById('replayMessage').style.display = 'none';
      document.getElementById('instructions').style.display = 'none';

      // Check if redirected from story page
      const isFromStory = window.location.href.includes('?fromStory=true');

      if (isFromStory) {
        // If coming from story page, start game directly
        console.log('Coming from story page, starting game directly');
        startScreen.style.display = 'none';
        document.querySelector('.header').style.display = 'block';
        document.getElementById('instructions').style.display = 'block';
        // Trigger game initialization
        window.dispatchEvent(new Event('gamestart'));
      } else {
        // Normal display of start button
        startButton.addEventListener('click', function () {
          // Hide start screen with fade out effect
          startScreen.style.transition = 'opacity 1s ease-out';
          startScreen.style.opacity = '0';
          setTimeout(() => {
            startScreen.style.display = 'none';
            // Show game elements
            document.querySelector('.header').style.display = 'block';
            document.getElementById('instructions').style.display = 'block';
            // Trigger game initialization (defined in main.js)
            window.dispatchEvent(new Event('gamestart'));
          }, 1000);
        });
      }
    });
  </script>

  <!-- Skip button -->
  <button id="skipButton">Skip Story</button>

  <!-- Preload two videos but hide them -->
  <video id="videoPreload" preload="auto" muted playsinline>
    <source src="storytelling/BG-Image.mp4" type="video/mp4">
  </video>
  <video id="videoPreload2" preload="auto" muted playsinline>
    <source src="storytelling/BG-Image-2.mp4" type="video/mp4">
  </video>

  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.11.5/dist/gsap.min.js"></script>
  <script>
    let scene, camera, renderer;
    let coverMesh, pageMesh, page2Mesh, page3Mesh, page4Mesh, page5Mesh, page6Mesh;
    let coverVideoElement = null; // Cover video element
    let coverVideoTexture = null; // Cover video texture
    let page1VideoElement = null; // Page1 video element
    let page1VideoTexture = null; // Page1 video texture 
    let page2VideoElement = null; // Page2 video element
    let page2VideoTexture = null; // Page2 video texture
    let page3VideoElement = null; // Page3 video element
    let page3VideoTexture = null; // Page3 video texture
    let page4VideoElement = null; // Page4 video element
    let page4VideoTexture = null; // Page4 video texture
    let page5VideoElement = null; // Page5 video element
    let page5VideoTexture = null; // Page5 video texture
    let page6VideoElement = null; // Page6 video element
    let page6VideoTexture = null; // Page6 video texture
    let clock = new THREE.Clock();
    let camTargetZ = 12;
    let storyShown = false;
    let isAnimating = false;
    let bookContainer;
    let currentPage = 1;
    let focusedPage = null;
    let originalPositions = {};
    let originalScales = {};

    // Variables for alternating video playback
    let videoElement1, videoElement2;
    let activeVideoElement;
    let videoTexture1, videoTexture2;
    let activeVideoTexture;
    let videoBackground;
    let isVideo1Active = true;

    // Global variable for debugging
    let debugVideoTexture = null;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      // Maintain moderate brightness settings to avoid color distortion
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.gammaFactor = 2.2;
      renderer.toneMappingExposure = 1.2;

      document.body.appendChild(renderer.domElement);

      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 14); // Adjust camera distance to ensure enlarged book is fully visible

      // Maintain moderate lighting intensity to avoid over-saturated colors
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.5));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
      dirLight.position.set(5, 10, 7.5);
      scene.add(dirLight);

      // Add moderate ambient light
      const ambientLight = new THREE.AmbientLight(0x606060, 0.8);
      scene.add(ambientLight);

      // Create book container, position in scene center
      bookContainer = new THREE.Group();
      bookContainer.position.set(0, 2, 0);
      scene.add(bookContainer);

      // Add video background support
      setupDualVideoBackground();

      // Only preload necessary videos
      preloadCoverVideo();
      preloadPage1Video();
      preloadPage2Video();
      preloadPage3Video();
      preloadPage4Video();
      preloadPage5Video();
      preloadPage6Video();

      // Set initial state: show cover
      currentPage = 0;

      // Set total number of pages to prevent accidental jumps to non-existent pages
      const totalPages = 7; // 0:Cover, 1:Page one, 2:Page two, 3:Page three, 4:Page four, 5:Page five, 6:Page six

      // Set camera observation position
      camTargetZ = 12;
      camera.position.z = 12;

      // Initial attempt to play videos
      setTimeout(function () {
        if (videoElement1) videoElement1.play().catch(e => console.error('Delayed start of video1 failed:', e));
        if (videoElement2) videoElement2.play().catch(e => console.error('Delayed start of video2 failed:', e));
        if (coverVideoElement) coverVideoElement.play().catch(e => console.error('Delayed start of cover video failed:', e));
      }, 1000);

      // Register window click event - handle user interaction
      window.addEventListener('click', (event) => {
        // Try to start all videos on user interaction (resolves autoplay restrictions in some browsers)
        startAllVideos();

        // If animation is in progress, ignore clicks
        if (isAnimating) {
          console.log("Animation in progress, ignoring click");
          return;
        }

        // Calculate mouse position and convert to normalized coordinates
        const mouse = new THREE.Vector2();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;  // Range: -1 to 1
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1; // Range: -1 to 1

        // Update the raycaster for detecting 3D object clicks
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);

        // Collect all objects that might be clicked - only check visible pages
        const clickableObjects = [];
        if (coverMesh && coverMesh.visible) clickableObjects.push(coverMesh);
        if (pageMesh && pageMesh.visible) clickableObjects.push(pageMesh);
        if (page2Mesh && page2Mesh.visible) clickableObjects.push(page2Mesh);
        if (page3Mesh && page3Mesh.visible) clickableObjects.push(page3Mesh);
        if (page4Mesh && page4Mesh.visible) clickableObjects.push(page4Mesh);
        if (page5Mesh && page5Mesh.visible) clickableObjects.push(page5Mesh);
        if (page6Mesh && page6Mesh.visible) clickableObjects.push(page6Mesh);

        // Check if the ray intersects with any clickable objects
        const intersects = raycaster.intersectObjects(clickableObjects);

        // If an interactive object was clicked
        // ... (内容太长，此处省略，但在实际编辑中这段代码会继续存在)
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Also update background size if it's created
        if (videoBackground) {
          updateBackgroundSize(videoBackground);
        }
      });

      // Add Skip button click event - 修改链接到game.html
      document.getElementById('skipButton').addEventListener('click', function () {
        console.log("Clicked Skip button, redirecting to game page");
        window.location.href = 'game.html?fromStory=true';
      });
    }

    // Preload cover video
    function preloadCoverVideo() {
      // Create hidden video element
      coverVideoElement = document.createElement('video');
      coverVideoElement.id = 'coverVideo';
      coverVideoElement.style.display = 'none';
      coverVideoElement.muted = true;
      coverVideoElement.playsInline = true;
      coverVideoElement.loop = true; // Loop playback
      coverVideoElement.crossOrigin = 'anonymous';
      coverVideoElement.preload = 'auto';

      // Add video source
      const source = document.createElement('source');
      source.src = 'storytelling/cover.mp4';
      source.type = 'video/mp4';
      coverVideoElement.appendChild(source);

      // Add to DOM
      document.body.appendChild(coverVideoElement);

      // Load video
      coverVideoElement.load();

      // Add load success event
      coverVideoElement.addEventListener('canplaythrough', function onCanPlay() {
        console.log('Cover video loaded, ready to play');

        // Create video texture
        if (!coverVideoTexture) {
          coverVideoTexture = new THREE.VideoTexture(coverVideoElement);
          coverVideoTexture.minFilter = THREE.LinearFilter;
          coverVideoTexture.magFilter = THREE.LinearFilter;
          coverVideoTexture.format = THREE.RGBAFormat;
          coverVideoTexture.encoding = THREE.sRGBEncoding;
          coverVideoTexture.generateMipmaps = false;

          // Create cover mesh
          const height = 5.5;
          const width = height * (2035 / 2044);

          const material = new THREE.MeshBasicMaterial({
            map: coverVideoTexture,
            side: THREE.DoubleSide,
            transparent: true,
          });

          const geometry = new THREE.PlaneGeometry(width, height);
          coverMesh = new THREE.Mesh(geometry, material);
          coverMesh.position.set(0, 0, 2); // Place cover in front center position
          coverMesh.scale.set(1.3, 1.3, 1.3); // Initial cover slightly enlarged
          coverMesh.userData = { type: 'cover' };
          bookContainer.add(coverMesh);

          // Save original position and scale of cover for reference by subsequent pages
          window.coverOriginalPosition = { x: 0, y: 0, z: 2 };
          window.coverOriginalScale = { x: 1.3, y: 1.3, z: 1.3 };

          // Save original transform of cover
          saveOriginalTransform(coverMesh);

          coverVideoElement.play().catch(e => {
            console.error('Unable to play cover video:', e);
          });

          console.log('Cover video mesh created');
        }

        // Remove event listener to avoid duplicate calls
        coverVideoElement.removeEventListener('canplaythrough', onCanPlay);
      });

      // Add error handling
      coverVideoElement.addEventListener('error', function (e) {
        console.error('Cover video loading failed:', e);
        // Load static image as fallback
        const loader = new THREE.TextureLoader();
        loader.load('storytelling/cover.jpg', function (texture) {
          coverVideoTexture = texture;

          // Create cover mesh
          const height = 5.5;
          const width = height * (2035 / 2044);

          const material = new THREE.MeshBasicMaterial({
            map: coverVideoTexture,
            side: THREE.DoubleSide,
            transparent: true,
          });

          const geometry = new THREE.PlaneGeometry(width, height);
          coverMesh = new THREE.Mesh(geometry, material);
          coverMesh.position.set(0, 0, 2); // Place cover in front center position
          coverMesh.scale.set(1.3, 1.3, 1.3); // Initial cover slightly enlarged
          coverMesh.userData = { type: 'cover' };
          bookContainer.add(coverMesh);

          // Save original position and scale of cover for reference by subsequent pages
          window.coverOriginalPosition = { x: 0, y: 0, z: 2 };
          window.coverOriginalScale = { x: 1.3, y: 1.3, z: 1.3 };

          // Save original transform of cover
          saveOriginalTransform(coverMesh);

          console.log('Cover image mesh created');
        });
      });

      console.log('Cover video preloading started');
    }

    // Preload page1 video
    function preloadPage1Video() {
      // Create hidden video element
      page1VideoElement = document.createElement('video');
      page1VideoElement.id = 'page1Video';
      page1VideoElement.style.display = 'none';
      page1VideoElement.muted = true;
      page1VideoElement.playsInline = true;
      page1VideoElement.loop = true; // Loop playback
      page1VideoElement.crossOrigin = 'anonymous';
      page1VideoElement.preload = 'auto';

      // Add video source
      const source = document.createElement('source');
      source.src = 'storytelling/page1.mp4';
      source.type = 'video/mp4';
      page1VideoElement.appendChild(source);

      // ... 其他代码 ...
    }

    // 这里是其他函数，包括animate(), preloadCoverVideo()等，与storytelling/index.html中相同
    // ...
  </script>
</body>

</html>